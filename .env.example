# Tap or Tarp - Environment Configuration
# Copy this file to .env and update values as needed

# Server Configuration
NODE_ENV=development
PORT=3000

# Storage Configuration
# Type: 'sqlite' (default), 'redis', or 'memory'
STORAGE_TYPE=sqlite

# SQLite Configuration (for single-instance deployment)
DB_PATH=./data/sessions.db

# Redis Configuration (for horizontal scaling / multi-instance)
# Set STORAGE_TYPE=redis and provide REDIS_URL to enable
# REDIS_URL=redis://username:password@host:port
# REDIS_URL=rediss://...  # For TLS connections
REDIS_URL=

# Instance ID (auto-generated if not set, uses FLY_ALLOC_ID on Fly.io)
# INSTANCE_ID=instance_1

# Logging Configuration
# Log level: trace, debug, info, warn, error, fatal
LOG_LEVEL=info

# Error Tracking (optional)
# Get your DSN from https://sentry.io
SENTRY_DSN=

# Session Configuration (milliseconds)
# How often to check for inactive sessions
SESSION_CLEANUP_INTERVAL=300000

# How long before an inactive session is deleted (24 hours default)
INACTIVE_SESSION_THRESHOLD=86400000

# How long before an empty session is deleted (5 minutes default)
EMPTY_SESSION_THRESHOLD=300000

# Game Defaults
DEFAULT_INITIAL_TIME=1800000
DEFAULT_WARNING_THRESHOLDS=300000,60000,30000

# Rate Limiting (future use)
# MAX_CONNECTIONS_PER_IP=10
# MAX_GAMES_PER_IP=5
# MESSAGE_RATE_LIMIT=20

# =============================================================================
# SECURITY
# =============================================================================

# WebSocket allowed origins (comma-separated)
# Leave empty to allow all origins (development mode)
# Use wildcards for subdomains: *.fly.dev
# Examples:
#   ALLOWED_ORIGINS=https://tap-or-tarp.fly.dev,https://mydomain.com
#   ALLOWED_ORIGINS=https://tap-or-tarp.fly.dev,*.mydomain.com
ALLOWED_ORIGINS=

# WebSocket message size limit: 64KB (not configurable, hardcoded for security)
# Content-Security-Policy: Enabled by default with strict settings
# Session reconnection tokens: Expire after 1 hour

# =============================================================================
# PROMETHEUS METRICS
# =============================================================================
# Metrics are exposed at GET /metrics in Prometheus format
#
# Available metrics:
#   - tapotarp_websocket_connections_total (gauge): Active WebSocket connections
#   - tapotarp_game_sessions_active (gauge): Active game sessions
#   - tapotarp_game_sessions_created_total (counter): Total sessions created
#   - tapotarp_websocket_messages_received_total (counter): Messages by type
#   - tapotarp_websocket_messages_sent_total (counter): Messages sent by type
#   - tapotarp_errors_total (counter): Errors by type
#   - tapotarp_authorization_denied_total (counter): Auth denied by action
#   - tapotarp_rate_limit_exceeded_total (counter): Rate limit violations
#   - tapotarp_game_tick_duration_seconds (histogram): Tick processing time
#   - tapotarp_storage_save_duration_seconds (histogram): Storage save time
#   - tapotarp_storage_operations_total (counter): Storage ops by type/status
#
# Prometheus scrape config example:
#   scrape_configs:
#     - job_name: 'tap-or-tarp'
#       static_configs:
#         - targets: ['localhost:3000']
#       metrics_path: '/metrics'
#       scrape_interval: 15s

# =============================================================================
# HORIZONTAL SCALING (Phase 4)
# =============================================================================
# For multi-instance deployment with shared state:
#
# 1. Set up Redis:
#    - Fly.io: fly redis create
#    - AWS: Use ElastiCache
#    - Self-hosted: Any Redis 6.0+ instance
#
# 2. Configure environment:
#    STORAGE_TYPE=redis
#    REDIS_URL=redis://your-redis-url
#
# 3. Features enabled with Redis:
#    - Session state shared across all instances
#    - Cross-instance game broadcasts via pub/sub
#    - Instance heartbeat and discovery
#    - Automatic failover support
#
# 4. Health endpoint includes Redis status:
#    GET /health returns:
#    {
#      "status": "healthy",
#      "instanceId": "...",
#      "redis": { "healthy": true, "latency": 1 }
#    }
#
# Note: Sticky sessions are recommended for WebSocket connections.
# On Fly.io, this is configured via fly.toml [[stickiness]] section.
